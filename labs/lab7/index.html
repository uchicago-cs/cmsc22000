<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Lab 7: Deployment  &middot; CS 220</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="">


<meta property="og:title" content="Lab 7: Deployment  &middot; CS 220 ">
<meta property="og:site_name" content="CS 220"/>
<meta property="og:url" content="https://uchicago-cs.github.io/cmsc22000/labs/lab7/" />
<meta property="og:locale" content="en-us">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2018-01-26T00:00:00Z" />
<meta property="og:article:modified_time" content="2018-01-26T00:00:00Z" />

  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="Lab 7: Deployment" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="https://uchicago-cs.github.io/cmsc22000/labs/lab7/" />
<meta name="twitter:domain" content="https://uchicago-cs.github.io/cmsc22000/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Lab 7: Deployment",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2018-01-26",
    "description": "",
    "wordCount":  1954 
  }
</script>



<link rel="canonical" href="https://uchicago-cs.github.io/cmsc22000/labs/lab7/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://uchicago-cs.github.io/touch-icon-144-precomposed.png">
<link href="https://uchicago-cs.github.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.55.5" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/cmsc22000/css/font-awesome.min.css">
<link rel="stylesheet" href="/cmsc22000/css/style.css">


  <link rel="stylesheet" href="https://uchicago-cs.github.io/cmsc22000/css/custom.css">
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


  
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-27880910-4', 'auto');
	  ga('send', 'pageview');

	</script>

</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="https://uchicago-cs.github.io/cmsc22000/">
  CS 220

</a>

</div>

  
<div class="container topline">
  
  Introduction to Software Development


</div>


</div>

  <nav class="container nav primary no-print">
  


  
<a href="https://uchicago-cs.github.io/cmsc22000/syllabus/">Syllabus</a>

<a href="https://uchicago-cs.github.io/cmsc22000/calendar/">Course Calendar</a>

<a href="https://uchicago-cs.github.io/cmsc22000/projects/2019/spec/">Project</a>

<a href="https://uchicago-cs.github.io/cmsc22000/labs/">Labs</a>

<a href="https://uchicago-cs.github.io/cmsc22000/resources/">Additional Resources</a>

<a href="https://uchicago-cs.github.io/cmsc22000/faq/">FAQs</a>


</nav>

<div class="container nav secondary no-print">
  





 


















</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>Lab 7: Deployment
</h1>

</header>

  <div class="container content">
  

<p><strong>Due:</strong> Thursday, May 23rd, 2:30pm</p>

<p>Last week, you learned about Continuous Integration, which deals with how application code makes it to the master branch. But how do our applications make it to the <em>real world</em>, where other people can use them?</p>

<p>Deployment refers to the processes by which software systems are made available for use (a related term, <em>delivery</em>, refers to making software available specifically to end-users). The exact deployment pipeline can vary from one project to another. For example, in a large financial company, deploying business management software might require system architects to come and physically upload software on the machines. On the other hand, if you&rsquo;re deploying a small web application, you just need a way to get your application from your computer to a server where other users can access it.</p>

<p>In this lab, you will deploy an application to <a href="https://www.heroku.com/">Heroku</a>, one of the most popular services for hosting web apps. You can see what your app <em>should</em> look like at <a href="https://cs220-helloapp.herokuapp.com/">https://cs220-helloapp.herokuapp.com/</a></p>

<h1 id="task-0-setup">Task 0: Setup</h1>

<p>[0 Points]</p>

<p>You should already have the “upstream” remote set up in your repository. If you do, simply run</p>

<pre><code>$ git pull upstream master
</code></pre>

<p>to get the files for this lab. If you don’t have the “upstream” remote set up, follow task 0 from <a href="/cmsc22000/labs/lab2/">Lab 2</a>.</p>

<p>Once you&rsquo;ve pulled from upstream, there should be a <code>labs/lab7</code> directory in your local repository with a <code>tasks.txt</code> file. In this lab, you will just have to copy-paste a few URLs that we will use to verify that you&rsquo;ve done the work in this lab.</p>

<p>Next, in this lab we&rsquo;ll be working with the small <a href="http://flask.pocoo.org/">Flask</a> web application we demonstrated in class. Don&rsquo;t worry: while the app is implemented in Python, no Python knowledge is necessary for this lab. First, you&rsquo;ll make a <strong>fork</strong> of the app. We covered forking in the <a href="/cmsc22000/labs/advanced-git/">Advanced Git Lab</a>, so you may want to review that lab if you&rsquo;re not 100% clear on what a fork is. In a nutshell, a fork is a new copy of a project under your own username. Forking a repository allows you to freely experiment with changes without affecting the original project (unless you choose to contribute back to the original project and the owners accept your contribution). Forking and then submitting pull requests across a fork is a very common practice in open source software development.</p>

<p>You can fork the <code>cs220-helloapp-2019</code> repository by going <a href="https://github.com/uchicago-cs/cs220-helloapp-2019">here</a> and clicking &ldquo;Fork&rdquo; in the upper right hand corner.</p>

<p>Once the fork has completed, you can clone it and begin your work. Remember to do this <em>outside</em> of your individual GitLab repository! (i.e., do <em>not</em> run the following command in the same directory that contains your <code>labs/</code>, <code>libgeometry/</code>, etc. directories, or inside the <code>labs/lab7</code> directory).</p>

<pre><code>$ git clone https://github.com/[yourusername]/cs220-helloapp-2019.git

</code></pre>

<p>Edit your <code>tasks.txt</code> file and include the URL of your forked <code>cs220-helloapp-2019</code> repository on GitHub.</p>

<p>Careful! Remember that your <code>tasks.txt</code> is in your personal repository on GitLab (with all your other lab files). You will <em>only</em> be using that repository to edit your <code>tasks.txt</code> file. The rest of your work will happen on the forked <code>cs220-helloapp</code> repository you just created.</p>

<h1 id="task-1-create-a-heroku-app">Task 1: Create a Heroku App</h1>

<p>[20 points]</p>

<p>Heroku is a common service used to host web applications. For this task you&rsquo;ll sign up for a (free) account and use it to deploy an app with an Internet-reachable URL.</p>

<ol>
<li>Go to <a href="https://signup.heroku.com/login">https://signup.heroku.com/login</a></li>
<li>Sign up and mark your &ldquo;role&rdquo; as &ldquo;student&rdquo;. You will need to confirm your account, and then create a password.</li>
</ol>

<p>Once you&rsquo;ve created your account, you&rsquo;re ready to create a Heroku app.</p>

<ol>
<li>Go to your dashboard, <a href="https://dashboard.heroku.com/apps">https://dashboard.heroku.com/apps</a></li>
<li>Click the big button that says &ldquo;Create new app&rdquo;</li>
<li>Under &ldquo;app-name&rdquo; title your app &ldquo;[cnetID]-cs220-lab7&rdquo;. This means that the url for your app will be &ldquo;https://[cnetID]-cs220-lab7.herokuapp.com&rdquo;</li>
</ol>

<p>You&rsquo;ve created your app! But navigate to &ldquo;https://[cnetID]-cs220-lab7.herokuapp.com&rdquo;. As you can see, there&rsquo;s nothing there. In the coming tasks we will get the helloapp up and running on this URL.</p>

<p>Before continuing, edit your <code>tasks.txt</code> file and include the URL of your app on Heroku.</p>

<h1 id="task-2-deploy-using-heroku-cli">Task 2: Deploy using Heroku CLI</h1>

<p>[20 points]</p>

<p>In class, we saw that we can deploy an app to Heroku simply by pushing to their Git repository. Your local <code>cs220-helloapp-2019</code> repository is currently configured to push only to GitHub, so we need to set it up to also push to Heroku. We can do this using a command-line tool provided by Heroku.</p>

<p>First, you&rsquo;ll need to log into Heroku like this:</p>

<pre><code>$ cd cs220-helloapp-2019
$ heroku login
</code></pre>

<aside class="admonition warning">
    <div class="admonition-icon">

    </div>

    <div class="admonition-content">
<p>Techstaff has set up the <code>heroku</code> command on the CSIL machines and the <code>linux.cs</code> servers.</p>

<p>If you are running inside the CS VM, then you will need to install Flask and the <code>heroku</code> command by running the following:</p>

<pre><code>$ sudo -H pip3 install flask
$ sudo snap install --classic heroku
</code></pre>

<p>If you are using the Headless VM setup, take into account that the <code>heroku login</code> command will attempt to open a browser to log you into Heroku, which is not possible from headless mode. Instead, the command will print out a URL, which you will have to manually copy/paste into a browser in your computer.</p>


</div>
</aside>

<p>The instructions for deploying using the CLI are located at <a href="https://dashboard.heroku.com/apps/[cnetID]-cs220-lab7/deploy/heroku-git">https://dashboard.heroku.com/apps/[cnetID]-cs220-lab7/deploy/heroku-git</a>. We already have a git repository, so we&rsquo;ll follow the instructions for <em>Existing Git Repository</em>.</p>

<pre><code>heroku git:remote -a [your app name]

</code></pre>

<p>So, we&rsquo;ve set up Heroku for this app, but we haven&rsquo;t deployed it yet&hellip; Navigate to your app&rsquo;s webpage, and you&rsquo;ll see nothing is there.</p>

<p>In order to deploy, you should use:</p>

<pre><code>$ git push heroku master
</code></pre>

<p>The <code>heroku git:remote</code> command you ran above added the <code>heroku</code> remote to your local repository, and pushing to it means that Heroku&rsquo;s servers will receive your code for the first time.</p>

<p>The version you just deployed happens to be a correct version of the app. We actually have a few tests that will run some basic checks to make sure the app is behaving as intended. You can run this tests simply by running this:</p>

<pre><code>pytest
</code></pre>

<p>This should produce an output like this:</p>

<pre><code>====================================== test session starts =======================================
platform linux -- Python 3.5.2, pytest-3.5.1, py-1.5.3, pluggy-0.6.0
rootdir: /var/tmp/borja/cs220-helloapp-2019, inifile:
plugins: metadata-1.7.0, json-0.4.0, html-1.17.0
collected 2 items

tests/test_greeting.py ..                                                                  [100%]

==================================== 2 passed in 0.02 seconds ====================================
</code></pre>

<p>Now, let&rsquo;s break our app. Edit the files <code>hello/templates/index.html</code> and replace <code>Hello</code> with <code>Howdy</code>. If you re-run the tests, one test will pass, but another will fail:</p>

<pre><code>====================================== test session starts =======================================
platform linux -- Python 3.5.2, pytest-3.5.1, py-1.5.3, pluggy-0.6.0
rootdir: /var/tmp/borja/cs220-helloapp-2019, inifile:
plugins: metadata-1.7.0, json-0.4.0, html-1.17.0
collected 2 items

tests/test_greeting.py .F                                                                  [100%]

============================================ FAILURES ============================================
_________________________________________ test_greeting __________________________________________

client = &lt;FlaskClient &lt;Flask 'hello.main'&gt;&gt;

    def test_greeting(client):
        &quot;&quot;&quot;
        Test that we get the correct greeting
        if we submit the form.
        &quot;&quot;&quot;

        name = b&quot;Random J. Hacker&quot;
        greeting = GREETING + b&quot;, &quot; + name + b&quot;!&quot;

        rv = client.post(&quot;/&quot;, data={&quot;name&quot;: name})

        # Test that the resulting page contains the app name
        # and the correct greeting.
        assert APPNAME in rv.data
&gt;       assert greeting in rv.data
E       assert b'Hello, Random J. Hacker!' in b'&lt;!doctype html&gt;\n&lt;title&gt;HelloApp&lt;/title&gt;\n&lt;link rel=&quot;stylesheet&quot; href=&quot;/static/style.css&quot;&gt;\n&lt;nav&gt;\n  &lt;h1&gt;HelloApp&lt;/h...h1&gt;\n\n  &lt;/header&gt;\n  \n\n&lt;p&gt;\n  Howdy, Random J. Hacker!\n&lt;/p&gt;\n&lt;p&gt;\n  &lt;a href=&quot;/&quot;&gt;Again!&lt;/a&gt;\n&lt;/p&gt;\n\n\n\n&lt;/section&gt;'
E        +  where b'&lt;!doctype html&gt;\n&lt;title&gt;HelloApp&lt;/title&gt;\n&lt;link rel=&quot;stylesheet&quot; href=&quot;/static/style.css&quot;&gt;\n&lt;nav&gt;\n  &lt;h1&gt;HelloApp&lt;/h...h1&gt;\n\n  &lt;/header&gt;\n  \n\n&lt;p&gt;\n  Howdy, Random J. Hacker!\n&lt;/p&gt;\n&lt;p&gt;\n  &lt;a href=&quot;/&quot;&gt;Again!&lt;/a&gt;\n&lt;/p&gt;\n\n\n\n&lt;/section&gt;' = &lt;Response 294 bytes [200 OK]&gt;.data

tests/test_greeting.py:33: AssertionError
=============================== 1 failed, 1 passed in 0.03 seconds ===============================
</code></pre>

<p>You don&rsquo;t need to understand everything that&rsquo;s going on here but, in a nutshell, the tests verified that the index page of our application works correctly, but one of the tests fail because the greeting we&rsquo;re receiving is &ldquo;Howdy&rdquo; instead of &ldquo;Hello&rdquo;.</p>

<p>It&rsquo;s a good thing we have the tests to tell us this but, unfortunately, nothing is preventing us from deploying this broken app. In fact, go ahead and deploy the broken code:</p>

<pre><code>$ git add hello/templates/index.html
$ git commit -m &quot;Broke the Internet!&quot;
$ git push heroku master
</code></pre>

<p>As you&rsquo;ll notice, you&rsquo;re still able to deploy your app. But it&rsquo;s now returning the wrong greeting, and millions of users are upset because they were expecting a polite &ldquo;Hello&rdquo; from the app, and now they&rsquo;re getting a much more folksy &ldquo;Howdy&rdquo;, which seems to rub some of our users the wrong way.</p>

<p>Is there a way we could prevent this, without manually checking every time? It would be nice if we could just deploy automatically from our GitHub repo, and only after CI tests pass.</p>

<p>Before continuing, make sure that you also push to your GitHub repository:</p>

<pre><code>$ git push
</code></pre>

<p>That way, we can check that you&rsquo;ve followed the steps described in this task.</p>

<h1 id="task-3-create-travis-yml-for-cs220-helloapp-2019">Task 3: Create .travis.yml for cs220-helloapp-2019</h1>

<p>[40 points]</p>

<p>As you remember from our <a href="/cmsc22000/labs/lab6/">previous lab</a>, we have a way to make sure our app passes all the tests every time we push.</p>

<p>For this, you should create a <code>.travis.yml</code> file in your <code>cs220-helloapp-2019</code> repo. With python, there&rsquo;s no need to build, so you should just define a test phase which runs the command <code>pytest</code> as its test script.</p>

<p>In the last task, you made the tests fail. You should ensure the CI job fails when the tests are failing.</p>

<p>Now, go back and fix the app so that they all pass. Before continuing, make sure you push your fixed app to both GitHub and to Heroku.</p>

<h1 id="task-4-deploy-using-github-integration-with-travis-ci">Task 4: Deploy using Github Integration with Travis CI</h1>

<p>[20 points]</p>

<p>Wouldn&rsquo;t it be convenient if we could deploy continuously, as soon as tests pass? You might think &ldquo;well, what if we had a deploy phase in our Travis CI&rdquo;? This is possible (see <a href="https://docs.travis-ci.com/user/deployment/heroku/">https://docs.travis-ci.com/user/deployment/heroku/</a>), but it turns out Heroku makes it <em>even easier</em> than that. On your Heroku app dashboard, in the &ldquo;Deploy&rdquo; tab, select &ldquo;GitHub - connect to GitHub&rdquo; instead of &ldquo;Heroku Git - Use Heroku CLI&rdquo;.</p>

<p>Then, you should be able to connect to GitHub using your GitHub account and repo name. Once you connect the repo, you should see an option that says &ldquo;Automatic deploys&rdquo; with a checkbox &ldquo;Wait for CI to pass before deploy&rdquo;.</p>

<p>Make the tests fail again and push to GitHub with a simple <code>git push</code>. The CI tests should fail and, if you navigate to your URL, you&rsquo;ll see that the broken version has not been deployed.</p>

<aside class="admonition warning">
    <div class="admonition-icon">

    </div>

    <div class="admonition-content">
<p><strong>Caution:</strong> In the above <code>git push</code> step, <em>don&rsquo;t</em> push to Heroku as you did in previous tasks. What&rsquo;s happening here is that the Heroku service will now wait for tests to pass CI, and then automagically pull your code and deploy it. No need to manually push to Heroku.</p>


</div>
</aside>

<p>Before continuing, fix the tests and make sure your CI tests are passing again.</p>

<p>Now, we&rsquo;re going to make a change that doesn&rsquo;t make the tests fail, to verify the change is correctly deployed just by pushing to GitHub. If you look at the app, you&rsquo;ll see that the main page shows the title &ldquo;What is your name?&rdquo; followed by a form with a field titled &ldquo;Name&rdquo;. That &ldquo;Name&rdquo; title seems a bit redundant, so we&rsquo;re going to remove it. Edit <code>hello/templates/index.html</code> and remove this line:</p>

<pre><code>    &lt;label for=&quot;name&quot;&gt;Name&lt;/label&gt;
</code></pre>

<p>Now, commit your changes and push to GitHub. Once the CI tests pass, your updated app should be available on Heroku, and you will be done with this lab! If your updated app doesn&rsquo;t deploy, check the &ldquo;Activity&rdquo; tab on your Heroku app dashboard, and see what the issue is: if it seems like it deployed correctly, you may simply need to wait a few minutes to see the website updated.</p>

<h3 id="submitting-your-lab">Submitting your lab</h3>

<p>Before submitting, make sure you&rsquo;ve committed your changes to the <code>lab7/tasks.txt</code> file (remember you can run <code>git status</code> to check this). Make sure you&rsquo;ve set up the <code>chisubmit</code> tool as described in <a href="/cmsc22000/labs/submit/">How to submit your labs</a>, and then run the following:</p>

<pre><code>chisubmit student assignment register lab7
chisubmit student assignment submit lab7
</code></pre>

</div>


  
</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  

  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  

</div>


  

</div>

</footer>

    </main>
    


    
  </body>
</html>

