
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Homework 3: Make &#8212; CMSC 22000 - Introduction to Software Development</title>

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/chiweb.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Homework 4: Debugging" href="hw4.html" />
    <link rel="prev" title="Homework 2: Software Design" href="hw2.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          CMSC 22000 - Introduction to Software Development</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              
              
            
            
            
<li class="dropdown">
    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Course Information <span class="caret"></span></a>
    <ul class="dropdown-menu">
        <li><a href="../syllabus.html">Syllabus</a></li>
        <li><a href="../calendar.html">Calendar</a></li>
        <li><a href="../code-of-conduct.html">Code of Conduct for Course Staff</a></li>
    </ul>
</li>
<li><a href="index.html">Homework</a></li>
<li class="dropdown">
    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Project <span class="caret"></span></a>
    <ul class="dropdown-menu">
        <li><a href="../project/index.html">Introduction</a></li>
        <li><a href="../project/chiventure.html">chiventure</a></li>
        <li><a href="../project/policies.html">Policies</a></li>
        <li><a href="../project/features.html">Features</a></li>
    </ul>
</li>
<li class="dropdown">
    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Resources <span class="caret"></span></a>
    <ul class="dropdown-menu">
        <li><a href="../resources/faq.html">CS 220 FAQs</a></li>
        <li><a href="../resources/tutorials/index.html">Tutorials</a></li>
        <li><a href="https://uchicago-cs.github.io/dev-guide/" target="_blank">UChicago CS Developer's Guide <i class="fa fa-external-link"></i></a></li>
        <li><a href="https://uchicago-cs.github.io/debugging-guide" target="_blank">The Debugging Guide <i class="fa fa-external-link"></i></a></li>
        <li><a href="../resources/other.html">Other Resources</a></li>
    </ul>
</li>

            
          </ul>

          

        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Homework 3: Make</a><ul>
<li><a class="reference internal" href="#project-team-exercise-design-warm-up-part-ii">Project Team Exercise: Design Warm-up (Part II)</a></li>
<li><a class="reference internal" href="#creating-your-homework-repository">Creating your homework repository</a></li>
<li><a class="reference internal" href="#task-1-a-simple-makefile">Task 1: A simple <code class="docutils literal notranslate"><span class="pre">Makefile</span></code></a></li>
<li><a class="reference internal" href="#task-2-lets-generalize">Task 2: Let’s generalize!</a></li>
<li><a class="reference internal" href="#task-3-building-a-somewhat-realistic-library">Task 3: Building a (somewhat) realistic library</a></li>
<li><a class="reference internal" href="#task-4-maximum-modularity-and-elegance">Task 4: Maximum modularity and elegance</a></li>
<li><a class="reference internal" href="#task-5-linking-with-your-library">Task 5: Linking with your library</a></li>
<li><a class="reference internal" href="#cmake">CMake</a></li>
<li><a class="reference internal" href="#submitting-your-homework">Submitting your homework</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <div class="section" id="homework-3-make">
<h1>Homework 3: Make<a class="headerlink" href="#homework-3-make" title="Permalink to this headline">¶</a></h1>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>This homework has not yet been updated for the Spring 2022 edition of CMSC 22000.
If you are currently taking this class, you’re welcome to take a look at the homework below,
but bear in mind that it could change substantially. Do not start working on the homework
until instructed to do so.</p>
</div>
<p><strong>Due:</strong> Wednesday, April 20st, 8pm CDT</p>
<p>In the class project, you will likely produce dozens of C files that
will ultimately produce a single executable. When dealing with multiple
source files, specially when there are dependencies between them, it is
common to use a <em>build system</em> instead of manually compiling and linking
all the files. in this homework, we’ll explore the ways a program can be
“built”–that is, the way that source code is turned into binary code so
that a computer can execute it. In some cases, “building” may refer to
compiling a single file, but usually it refers to the whole process of
linking and creating a project: which can include linking, compiling,
and running tests. We’ll look at testing in later homeworks, and for this homework
we’ll focus on the <code class="docutils literal notranslate"><span class="pre">make</span></code> command as a way to compile and build
projects.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For some of these tasks, you may be tempted to
look at the Makefiles included with libgeometry, and copy-paste parts of
them into your Makefiles. There are two important reasons not to do
this:</p>
<ol class="arabic simple">
<li><p>It is important that you understand what you’re doing in each of the
tasks in this homework. If you get stuck and you’re not sure how to
proceed, please make sure to ask for help. If you just copy-paste
from one of our Makefiles, you won’t understand how those parts of
the Makefile work.</p></li>
<li><p>The tasks in this homework actually ask you to modify a Makefile in ways
that are different from how the libgeometry Makefile is written. If
you just copy-paste from our Makefile, it is almost certain we will
be able to tell that you did so.</p></li>
</ol>
<p>That said, by the end of this homework you should be able to understand
almost everything that is contained in the libgeometry Makefiles.
However, it is important that you perform all the intermediate tasks
before you get to that point.</p>
</div>
<p>Finally, for your reference, you may find the following resources
helpful:</p>
<ul class="simple">
<li><p>The GNU <code class="docutils literal notranslate"><span class="pre">make</span></code> documentation, available in full
<a class="reference external" href="https://www.gnu.org/software/make/manual/html_node/index.html">here</a>;
and</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">make</span></code> and <code class="docutils literal notranslate"><span class="pre">gcc</span></code> man pages, available in your terminal
through <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">make</span></code> and <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">gcc</span></code>.</p></li>
</ul>
<div class="section" id="project-team-exercise-design-warm-up-part-ii">
<h2>Project Team Exercise: Design Warm-up (Part II)<a class="headerlink" href="#project-team-exercise-design-warm-up-part-ii" title="Permalink to this headline">¶</a></h2>
<p>Along with this week’s homework, we are also assigning the second part of the
design warm-up exercise, which you can find <a class="reference external" href="../project/design.html">here</a>.
Please note that the second part of the design exercise is due at the same time as this homework.</p>
</div>
<div class="section" id="creating-your-homework-repository">
<h2>Creating your homework repository<a class="headerlink" href="#creating-your-homework-repository" title="Permalink to this headline">¶</a></h2>
<p>Like previous homeworks, we will provide you with an <em>invitation URL</em> that
will allow you sign up for the homework assignment on GitHub, and which will
result in the creation of a repository called
<code class="docutils literal notranslate"><span class="pre">2021-hw3-GITHUB_USERNAME</span></code> inside our <code class="docutils literal notranslate"><span class="pre">uchicago-cmsc22000</span></code> organization
on GitHub. Like Homework #2, your repository will be seeded with some files
for the homework, which will be contained in four <code class="docutils literal notranslate"><span class="pre">task</span></code> directories inside
the repository.</p>
</div>
<div class="section" id="task-1-a-simple-makefile">
<h2>Task 1: A simple <code class="docutils literal notranslate"><span class="pre">Makefile</span></code><a class="headerlink" href="#task-1-a-simple-makefile" title="Permalink to this headline">¶</a></h2>
<p>(15 points)</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">task1</span></code> directory, you’ll see a simple program (<code class="docutils literal notranslate"><span class="pre">greet.c</span></code>)
that prints “Hello there” to the screen and exits. As you’ve done in
previous courses, you can compile and run the program like so:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcc -o greet greet.c
$ ./greet
Hello there
</pre></div>
</div>
<p>And when you’re done, you can always remove the executable (also called
the binary) to prevent adding it to version control like so:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ rm -f greet
</pre></div>
</div>
<p>Now, let’s say you want to change your program so that instead of
printing “Hello there”, it prints “General Kenobi!” You either have to
hit the up arrow on your keyboard a million times, or remember
<code class="docutils literal notranslate"><span class="pre">gcc</span> <span class="pre">-o</span> <span class="pre">greet</span> <span class="pre">greet.c</span></code>. And perhaps you want to enable optimizations,
enable all the warnings, and enable debugging symbols (so you can use
<code class="docutils literal notranslate"><span class="pre">gdb</span></code>):</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcc -O2 -Wall -Wextra -g -o greet greet.c
</pre></div>
</div>
<p>Yuck! Who likes typing all that every time? Let’s simplify this process
using <code class="docutils literal notranslate"><span class="pre">make</span></code>. <code class="docutils literal notranslate"><span class="pre">make</span></code> is a simple tool that does one and only one
thing: it looks for a file in the current directory called <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>,
and executes commands according to <strong>rules</strong> specified in the
<code class="docutils literal notranslate"><span class="pre">Makefile</span></code>. A rule looks something like this:</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nf">rule-name</span><span class="o">:</span> <span class="n">prerequisite</span>
    <span class="nb">command</span>
</pre></div>
</div>
<p>In general, rules can have any number of (or zero) prerequisites
(separated by spaces), and any number of (or zero) commands (separated
by newlines). It’s important to note that while <code class="docutils literal notranslate"><span class="pre">make</span></code> is probably
most often used with C programs, <code class="docutils literal notranslate"><span class="pre">make</span></code> is a generic tool supporting
arbitrary commands. Here’s a simple “hello world” <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>, that
uses the shell command “echo” (which does exactly what you think it
does):</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nf">hello</span><span class="o">:</span>
    <span class="nb">echo</span> <span class="s2">&quot;Hello&quot;</span>

<span class="nf">world</span><span class="o">:</span> <span class="n">hello</span>
    <span class="nb">echo</span> <span class="s2">&quot;World!&quot;</span>
</pre></div>
</div>
<p>We can use this <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> like so:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ make hello
<span class="nb">echo</span> <span class="s2">&quot;Hello&quot;</span>
Hello
$ make world
<span class="nb">echo</span> <span class="s2">&quot;Hello&quot;</span>
Hello
<span class="nb">echo</span> <span class="s2">&quot;World!&quot;</span>
World!
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Beware the curse of the tabs and the missing separators!</strong></p>
<p>If you get an error message like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Makefile</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span> <span class="o">***</span> <span class="n">missing</span> <span class="n">separator</span><span class="o">.</span>  <span class="n">Stop</span><span class="o">.</span>
</pre></div>
</div>
<p>This means there may have been an issue when copy-pasting from this page
to the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>. More specifically, Makefiles use <a class="reference external" href="https://en.wikipedia.org/wiki/Tab_key">tab
characters</a> to indent the
commands in a rule. This makes it challenging to edit Makefiles if you
have set up your editor to use spaces to indent your code. If you’re
getting the “missing separator error”, it’s likely that your editor
automatically converted the tab characters to spaces.</p>
<p>If that is the case, you can tell <code class="docutils literal notranslate"><span class="pre">make</span></code> to use spaces instead of tabs
by adding the following at the top of your Makefile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">RECIPEPREFIX</span> <span class="o">+=</span>
</pre></div>
</div>
</div>
<p>First, notice how <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">hello</span></code> prints both the command that is run by
that rule, as well as the result of running that command. Next, notice
how since the <code class="docutils literal notranslate"><span class="pre">world</span></code> rule depends on the <code class="docutils literal notranslate"><span class="pre">hello</span></code> rule, the
<code class="docutils literal notranslate"><span class="pre">hello</span></code> rule is executed first when we run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">world</span></code>. It’s
important to note that the topmost rule in a file (that is, the rule
defined the earliest in the file) is the <strong>default rule</strong>, which means
that it will be executed when calling <code class="docutils literal notranslate"><span class="pre">make</span></code> with no arguments. In the
case above, <code class="docutils literal notranslate"><span class="pre">make</span></code> and <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">hello</span></code> will produce identical output.</p>
<p>One more thing to note is that since <code class="docutils literal notranslate"><span class="pre">make</span></code> was designed to work with
C, it also has a number of <em>implicit rules</em>. For example, run the
following to delete the <code class="docutils literal notranslate"><span class="pre">greet</span></code> program we created earlier:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ rm -f greet
</pre></div>
</div>
<p>Now, run this:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ make greet
</pre></div>
</div>
<p>Our Makefile doesn’t have a <code class="docutils literal notranslate"><span class="pre">greet</span></code> rule and, yet, because there is a
<code class="docutils literal notranslate"><span class="pre">greet.c</span></code> file, <code class="docutils literal notranslate"><span class="pre">make</span></code> interprets that as “I should generate a
<code class="docutils literal notranslate"><span class="pre">greet</span></code> executable from <code class="docutils literal notranslate"><span class="pre">greet.c</span></code>”. Similarly, if you run this:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ make greet.o
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">make</span></code> will generate an object file from <code class="docutils literal notranslate"><span class="pre">greet.c</span></code> (but won’t
generate an executable).</p>
<p>The problem here is that if we have a rule called <code class="docutils literal notranslate"><span class="pre">clean</span></code>, we can’t
ever create a file called <code class="docutils literal notranslate"><span class="pre">clean.c</span></code> in the current directory, or
<code class="docutils literal notranslate"><span class="pre">make</span></code> will get confused as to whether it’s supposed to use our rule
or apply an implicit rule. Poor design, sure, but it can be mitigated by
adding the following to your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>:</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">rule</span>1 <span class="n">rule</span>2 ...<span class="n">etc</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">rule1</span></code> and <code class="docutils literal notranslate"><span class="pre">rule2</span></code> and so on are the names of the rules
you’ve defined in your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>.</p>
<p>For this task, create a file called <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> in the <code class="docutils literal notranslate"><span class="pre">task1</span></code>
directory with two rules:</p>
<ol class="arabic simple">
<li><p>A rule called <code class="docutils literal notranslate"><span class="pre">all</span></code> that compiles the program using <code class="docutils literal notranslate"><span class="pre">gcc</span></code>; and</p></li>
<li><p>A rule called <code class="docutils literal notranslate"><span class="pre">clean</span></code> that removes the binary produced by <code class="docutils literal notranslate"><span class="pre">all</span></code>.</p></li>
</ol>
<p>You can run the rules in your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> by running <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span></code> and
<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code>.</p>
<p>The order in which you specify the rules is not significant <em>except</em>
that the first rule in the file will be the <em>default</em> rule, meaning that
it will be selected whenever you run <code class="docutils literal notranslate"><span class="pre">make</span></code> without any parameters. If
you want to run any other rule, you have to specify the rule name when
running <code class="docutils literal notranslate"><span class="pre">make</span></code> (e.g., <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code>). So, it is common to call the
default rule <code class="docutils literal notranslate"><span class="pre">all</span></code>, and to have that rule build our entire
program.</p>
<p>Once you’re done, add your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> to git, commit it, and push.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Building produces a number of binary files,
including object files, executables, and (as we’ll see later in this
homework) library files. These should <em>never</em> be added to your Git
repository! You’ll notice that there’s actually a <code class="docutils literal notranslate"><span class="pre">.gitignore</span></code> file in
the root of your repository with a list of files that Git should ignore
(so you won’t inadvertently add them to your repository). It is good
practice to have such a file in any repository you create, to make sure
you never add binary files to your repository.</p>
</div>
</div>
<div class="section" id="task-2-lets-generalize">
<h2>Task 2: Let’s generalize!<a class="headerlink" href="#task-2-lets-generalize" title="Permalink to this headline">¶</a></h2>
<p>(15 points)</p>
<p>What happens if we want to change the name of the binary to <code class="docutils literal notranslate"><span class="pre">shblah</span></code>?
We’d have to go into our <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> and replace every occurrence of
<code class="docutils literal notranslate"><span class="pre">hello</span></code> with <code class="docutils literal notranslate"><span class="pre">shblah</span></code>. That might be fine for now, but when our
<code class="docutils literal notranslate"><span class="pre">Makefile</span></code>s have more rules and are being used to compile lots of
different C files, that simply won’t do. Fortunately, <code class="docutils literal notranslate"><span class="pre">make</span></code> includes
a notion of <strong>variables</strong> that we can use here. Working with the example
from task 1, they work like so:</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">COMMAND</span> <span class="o">=</span> <span class="nb">echo</span>

<span class="nf">hello</span><span class="o">:</span>
    <span class="k">$(</span>COMMAND<span class="k">)</span> <span class="s2">&quot;Hello&quot;</span>

<span class="nf">world</span><span class="o">:</span> <span class="n">hello</span>
    <span class="k">$(</span>COMMAND<span class="k">)</span> <span class="s2">&quot;World!&quot;</span>
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> works the same as it did above, but now if we ever
want to change <code class="docutils literal notranslate"><span class="pre">echo</span></code> to a different command, we need only change it
in one place. In general, variables are used to avoid repeating code
between rules. If we have multiple rules specified for compiling
different C files, and the only flag they don’t share is the output
flag, we wouldn’t want to type out
<code class="docutils literal notranslate"><span class="pre">gcc</span> <span class="pre">-g</span> <span class="pre">-O2</span> <span class="pre">-Wall</span> <span class="pre">-Wextra</span> <span class="pre">-g</span> <span class="pre">-o</span> <span class="pre">hello</span> <span class="pre">hello.c</span></code>. We’d rather type
<code class="docutils literal notranslate"><span class="pre">gcc</span> <span class="pre">$(CFLAGS)</span> <span class="pre">-o</span> <span class="pre">hello</span> <span class="pre">hello.c</span></code>. That way, if we then want to change
the optimization level or add a warning flag, we need only change the
<code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> variable.</p>
<p>For task 2, copy your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> from task 1 into the <code class="docutils literal notranslate"><span class="pre">task2</span></code>
directory, and add the following four variables:</p>
<ol class="arabic simple">
<li><p>A variable called <code class="docutils literal notranslate"><span class="pre">BIN</span></code> that is used for passing the name of the
binary to <code class="docutils literal notranslate"><span class="pre">gcc</span></code> and <code class="docutils literal notranslate"><span class="pre">rm</span></code>; and</p></li>
<li><p>A variable called <code class="docutils literal notranslate"><span class="pre">CC</span></code> that specifies the C compiler to be used (in
our case this is just gcc, but it’s important to have this as an
option; for example, we may want to use a different C compiler, like
<code class="docutils literal notranslate"><span class="pre">clang</span></code>); and</p></li>
<li><p>A variable called <code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> (a very common practice) that holds the
common extra options passed into <code class="docutils literal notranslate"><span class="pre">gcc</span></code> (you should include the
optimization, warning, and debug flags in the example from task 1);
and</p></li>
<li><p>A variable called <code class="docutils literal notranslate"><span class="pre">RM</span></code> that specifies the <code class="docutils literal notranslate"><span class="pre">rm</span></code> command along with
its options.</p></li>
</ol>
<p>Then, update your rules to use the newly-defined variables (that is,
replace instances of <code class="docutils literal notranslate"><span class="pre">gcc</span></code> with <code class="docutils literal notranslate"><span class="pre">$(CC)</span></code>, and so on). You should make
a commit at this point.</p>
</div>
<div class="section" id="task-3-building-a-somewhat-realistic-library">
<h2>Task 3: Building a (somewhat) realistic library<a class="headerlink" href="#task-3-building-a-somewhat-realistic-library" title="Permalink to this headline">¶</a></h2>
<p>(15 + 20 points)</p>
<p>This task is split into two phases: the first will help you familiarize
yourself with the structure of a project with multiple files, and the
second will actually have you build the project as a library.</p>
<p>In the task 3 directory, you’ll see a new program structure. We have two
header files in the <code class="docutils literal notranslate"><span class="pre">include</span></code> directory, and three C files in the
<code class="docutils literal notranslate"><span class="pre">src</span></code> directory. Basically, we have <code class="docutils literal notranslate"><span class="pre">obi_wan.c</span></code> and <code class="docutils literal notranslate"><span class="pre">obi_wan.h</span></code>,
which define a function called <code class="docutils literal notranslate"><span class="pre">hello_there</span></code>, that prints
<code class="docutils literal notranslate"><span class="pre">Hello</span> <span class="pre">there</span></code> to the screen. Similarly, we have <code class="docutils literal notranslate"><span class="pre">grievous.c</span></code> and
<code class="docutils literal notranslate"><span class="pre">grievous.h</span></code>, which define <code class="docutils literal notranslate"><span class="pre">general_kenobi</span></code>, which prints
<code class="docutils literal notranslate"><span class="pre">General</span> <span class="pre">Kenobi!</span></code> to the screen. <code class="docutils literal notranslate"><span class="pre">main.c</span></code> defines a <code class="docutils literal notranslate"><span class="pre">main</span></code>
function that calls <code class="docutils literal notranslate"><span class="pre">hello_there</span></code> and <code class="docutils literal notranslate"><span class="pre">general_kenobi</span></code>. To compile
these files together, recall from 152 / 162 that you have to pass them
to <code class="docutils literal notranslate"><span class="pre">gcc</span></code> like so:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcc -g -O2 -Wall -Wextra -g src/main.c src/obi_wan.c src/grievous.c -o hello
</pre></div>
</div>
<p>There’s a problem with this: how does <code class="docutils literal notranslate"><span class="pre">gcc</span></code> know where to find the
header files? For this we use the <code class="docutils literal notranslate"><span class="pre">-I</span></code> flag:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcc -g -O2 -Wall -Wextra -g -I ./include/ src/main.c src/obi_wan.c src/grievous.c -o hello
</pre></div>
</div>
<p>Yuck! Let’s streamline this. Copy your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> from the previous
task and add a new variable, <code class="docutils literal notranslate"><span class="pre">SRCS</span></code>, that defines the list of source
files to pass to <code class="docutils literal notranslate"><span class="pre">gcc</span></code>. Furthermore, you’ll need to modify your
<code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> variable to add the new <code class="docutils literal notranslate"><span class="pre">-I</span> <span class="pre">./include/</span></code> option, so that
<code class="docutils literal notranslate"><span class="pre">make</span></code> knows where to find our header files. You should make a commit
at this point.</p>
<p>Now on to phase 2. Due to overwhelming demand from your userbase, you’re
going to package these files up as a <strong>library</strong> that other people can
include in their projects. This means that instead of producing an
executable file (that we can run like <code class="docutils literal notranslate"><span class="pre">./hello</span></code>), you’re going to
produce a dynamically-linked library, like the ones we described in
class.</p>
<p>First, remove the <code class="docutils literal notranslate"><span class="pre">main.c</span></code> file - we don’t want <code class="docutils literal notranslate"><span class="pre">main</span></code> in a library.
From inside the <code class="docutils literal notranslate"><span class="pre">task3</span></code> directory:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ git rm src/main.c
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">rm</span></code> command both removes the file from the
filesystem, <em>and</em> removes it from version control. You should now make a
commit with the message “Starting task 3 phase 2”.</p>
<p>First things first: we’re no longer building a binary called <code class="docutils literal notranslate"><span class="pre">hello</span></code>,
we’re building a <strong>shared object file</strong> called <code class="docutils literal notranslate"><span class="pre">libstarwars.so</span></code>. For
starters, go ahead and change your <code class="docutils literal notranslate"><span class="pre">BIN</span></code> variable to be called
<code class="docutils literal notranslate"><span class="pre">LIB</span></code>, and have it specify <code class="docutils literal notranslate"><span class="pre">libstarwars.so</span></code>. At this point, we need
to radically change the compilation structure of our project. Up till
now, we’ve been basically asking <code class="docutils literal notranslate"><span class="pre">gcc</span></code> to compile our set of C files,
take the resultant machine code, and mash it together into a single file
that we can run. Instead, to build a library, we’re going to invoke
<code class="docutils literal notranslate"><span class="pre">gcc</span></code> <em>individually</em>, once per file that’s part of the compilation,
and ask it to produce an <strong>object</strong> file. Then, we’ll invoke <code class="docutils literal notranslate"><span class="pre">gcc</span></code> one
more time, asking it to mash all the object files together into one
large <strong>shared object</strong> file.</p>
<p>To compile a file <code class="docutils literal notranslate"><span class="pre">hello.c</span></code> into an object file <code class="docutils literal notranslate"><span class="pre">hello.o</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcc -Wall -Wextra -O2 -g -fPIC -c -o hello.o hello.c
</pre></div>
</div>
<p>Note the presence of the new <code class="docutils literal notranslate"><span class="pre">gcc</span></code> flag <code class="docutils literal notranslate"><span class="pre">-fPIC</span></code>. This flag tells
<code class="docutils literal notranslate"><span class="pre">gcc</span></code> to enable position-independent code. Position-independence is
beyond the scope of this homework, but it’s necessary for building shared
libraries. Accordingly, you’ll need to add <code class="docutils literal notranslate"><span class="pre">-fPIC</span></code> to your <code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code>.</p>
<p>To build one or several object files into a shared library, we would do
this:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gcc -shared -o libhello.so hello.o
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">-shared</span></code> option, unsurprisingly, tells <code class="docutils literal notranslate"><span class="pre">gcc</span></code> to output a shared
object file.</p>
<p>Add a rule to your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> for <code class="docutils literal notranslate"><span class="pre">obi_wan.o</span></code> and <code class="docutils literal notranslate"><span class="pre">grievous.o</span></code>,
specifying how to compile them, using your previously-defined variables.
Then, make the <code class="docutils literal notranslate"><span class="pre">all</span></code> rule depend on each of those new object rules.
Finally, change the <code class="docutils literal notranslate"><span class="pre">all</span></code> rule to compile those two <code class="docutils literal notranslate"><span class="pre">.o</span></code> files into
a shared library. You’ll likely want an <code class="docutils literal notranslate"><span class="pre">OBJS</span></code> variable, which defines
<code class="docutils literal notranslate"><span class="pre">.o</span></code> files for each <code class="docutils literal notranslate"><span class="pre">.c</span></code> file in the <code class="docutils literal notranslate"><span class="pre">SRCS</span></code> variable. You should
make a commit at this point.</p>
</div>
<div class="section" id="task-4-maximum-modularity-and-elegance">
<h2>Task 4: Maximum modularity and elegance<a class="headerlink" href="#task-4-maximum-modularity-and-elegance" title="Permalink to this headline">¶</a></h2>
<p>(15 points)</p>
<p>In task 3, you defined separate, explicit rules for each object file in
the project. This has a number of disadvantages: you repeat a lot of
code, and if you want to, say, change the name of a variable or update
the structure of the compilation command, you have to make those changes
in multiple places. To combat this problem, <code class="docutils literal notranslate"><span class="pre">make</span></code> includes many
built-in variables and functions to aid in writing concise, elegant
<code class="docutils literal notranslate"><span class="pre">Makefile</span></code>s. Here are some of the more useful variables and
functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$&#64;</span></code> is the name of the current rule</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$^</span></code> is the names of all the prerequisites, separated by spaces</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$&lt;</span></code> is the name of the first prerequisite</p></li>
<li><p>There are three different patterns for substituting text:</p>
<ul>
<li><p>In a prerequisite, you can do substitution like so: <code class="docutils literal notranslate"><span class="pre">%.o:%.c</span></code>.
This means: “take a file and substitute the extension <code class="docutils literal notranslate"><span class="pre">.o</span></code> for
the extension <code class="docutils literal notranslate"><span class="pre">.c</span></code>”.</p></li>
<li><p>In a variable, you can do substitution like so:
<code class="docutils literal notranslate"><span class="pre">FOO</span> <span class="pre">=</span> <span class="pre">$(BAR:.txt=.pdf)</span></code>. This means: “take the <code class="docutils literal notranslate"><span class="pre">BAR</span></code>
variable, substitute the <code class="docutils literal notranslate"><span class="pre">.txt</span></code> extension for <code class="docutils literal notranslate"><span class="pre">.pdf</span></code> in all
files in <code class="docutils literal notranslate"><span class="pre">BAR</span></code>, and then save the result in <code class="docutils literal notranslate"><span class="pre">FOO</span></code>.”</p></li>
</ul>
</li>
<li><p>Inside a rule, you can use the <code class="docutils literal notranslate"><span class="pre">patsubst</span></code> function like so:
<code class="docutils literal notranslate"><span class="pre">gcc</span> <span class="pre">$(patsubst</span> <span class="pre">%.o,%.d,$&#64;)</span></code>. This means: “take the name of the
current rule, substitute the extension <code class="docutils literal notranslate"><span class="pre">.o</span></code> for <code class="docutils literal notranslate"><span class="pre">.d</span></code>, and pass
that file to gcc”.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">.d</span></code> files (aka, “dependency files”), which you will
encounter in libgeometry and in other projects, are special files that
list out all the header files that the project depends on. This is
because by default, <code class="docutils literal notranslate"><span class="pre">make</span></code> does not track changes to .h files, while
it does track changes to .c files. So, we use a special flag in gcc (the
<code class="docutils literal notranslate"><span class="pre">-MM</span></code> flag which you can read more about in <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">gcc</span></code>) which
compiles a list of header files that the code depends on. <code class="docutils literal notranslate"><span class="pre">make</span></code> can
then use that <code class="docutils literal notranslate"><span class="pre">.d</span></code> file to figure out when a header file has been
modified and recompile the code accordingly.</p>
<p>Please note that you do not need to worry about <code class="docutils literal notranslate"><span class="pre">.d</span></code> files in this
homework.</p>
</div>
<p>Finally, rules can have variable names: if you want to parameterize a
rule so that it works for any files in a list of files, you could name a
rule <code class="docutils literal notranslate"><span class="pre">$(SRCS)</span></code>. Consider the following rule:</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nf">$(OBJS)</span><span class="o">:</span> %.<span class="n">o</span>:%.<span class="n">c</span>
  <span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> -c -o <span class="nv">$@</span> <span class="k">$(</span>patsubst %.o, %.c, <span class="nv">$@</span><span class="k">)</span>
</pre></div>
</div>
<p>There’s a lot going on here, so let’s unpack it all. Naming the rule
<code class="docutils literal notranslate"><span class="pre">$(OBJS)</span></code> means that any filename in <code class="docutils literal notranslate"><span class="pre">$(OBJS)</span></code> will match this rule.
That is, if <code class="docutils literal notranslate"><span class="pre">$(OBJS)</span></code> is <code class="docutils literal notranslate"><span class="pre">OBJS</span> <span class="pre">=</span> <span class="pre">src/obi_wan.o</span> <span class="pre">src/grievous.o</span></code>, and
we call <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">src/grievous.o</span></code>, it will run this command. Next, since
the rule name is a parameter, it’s not really clear what <code class="docutils literal notranslate"><span class="pre">$&#64;</span></code>
represents. In the case of a parameterized rule, <code class="docutils literal notranslate"><span class="pre">$&#64;</span></code> is the value of
the parameter that triggered the rule. So if we call
<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">src/grievous.o</span></code>, then <code class="docutils literal notranslate"><span class="pre">$&#64;</span></code> will be <code class="docutils literal notranslate"><span class="pre">src/grievous.o</span></code>.
Similarly, if we call <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">src/obi_wan.o</span></code>, then <code class="docutils literal notranslate"><span class="pre">$&#64;</span></code> will be
<code class="docutils literal notranslate"><span class="pre">src/obi_wan.o</span></code>. Finally, the <code class="docutils literal notranslate"><span class="pre">%.o:%.c</span></code> part marks all <code class="docutils literal notranslate"><span class="pre">.c</span></code> files
corresponding to the <code class="docutils literal notranslate"><span class="pre">.o</span></code> files in <code class="docutils literal notranslate"><span class="pre">OBJS</span></code> as prerequisites. Marking
a <code class="docutils literal notranslate"><span class="pre">.c</span></code> file as a prerequisite means that when you run any rule that
depends on that file, <code class="docutils literal notranslate"><span class="pre">make</span></code> will first check if that file has been
changed since the last time was run, and if it was changed, will run any
other prerequisites first (to ensure your whole project is up-to-date).</p>
<p>Given this information, take your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> from task 3, copy it to
the task 4 directory, and modularize it: you should have no hardcoded
rules or values, except for flags/filenames/etc that only apply to one
specific rule. Note that there are possibly many correct ways to do
this. You should make a commit at this point.</p>
</div>
<div class="section" id="task-5-linking-with-your-library">
<h2>Task 5: Linking with your library<a class="headerlink" href="#task-5-linking-with-your-library" title="Permalink to this headline">¶</a></h2>
<p>(20 points)</p>
<p>At this point, you have a Makefile that produces a <code class="docutils literal notranslate"><span class="pre">libstarwars.so</span></code>
library. For this final task, you must create a <code class="docutils literal notranslate"><span class="pre">task5</span></code> directory, and
write a C file in it that uses the <code class="docutils literal notranslate"><span class="pre">libstarwars.so</span></code> library, and a
Makefile that correctly builds and runs your program. We have not
explicitly explained some of the steps that will be required to do this,
but you may use the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> from the <code class="docutils literal notranslate"><span class="pre">samples/</span></code> directory in
<a class="reference external" href="https://github.com/uchicago-cs/cmsc22000/tree/master/examples/libgeometry">libgeometry</a>
as a guide. However, it is not enough for you to copy-paste parts of
that <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>: your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> for this task must be annotated
with comments (comments in Makefiles begin with <code class="docutils literal notranslate"><span class="pre">#</span></code>). These comments
must explain what each rule does, and you must explain any detail or
feature that was not explicitly explained earlier in the homework.</p>
<p>You must also include a <code class="docutils literal notranslate"><span class="pre">readme.txt</span></code> file with instructions on how to
build and run your program. Remember that, by default, programs running
on a Linux system will look for shared libraries in specific locations,
so you must tell us how we must run your program so that it can
correctly find the <code class="docutils literal notranslate"><span class="pre">libstarwars.so</span></code> library when it runs.</p>
</div>
<div class="section" id="cmake">
<h2>CMake<a class="headerlink" href="#cmake" title="Permalink to this headline">¶</a></h2>
<p>While you have learned about Make in this homework, the course project uses a
more advanced build system called <a class="reference external" href="https://cmake.org/">CMake</a>, which
actually provides a layer of abstraction over Make. For example, this is
was a simple CMake file for building a library looks like:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.5.1</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">libstarwars</span> <span class="s">C</span><span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_STANDARD</span> <span class="s">11</span><span class="p">)</span>

<span class="nb">include_directories</span><span class="p">(</span><span class="s">include/</span><span class="p">)</span>

<span class="nb">add_library</span><span class="p">(</span><span class="s">starwars</span> <span class="s">SHARED</span>
            <span class="s">src/obi_wan.c</span>
            <span class="s">src/grievous.c</span><span class="p">)</span>
</pre></div>
</div>
<p>You can try this CMake build file by saving it as <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>
inside the <code class="docutils literal notranslate"><span class="pre">task4</span></code> directory. Then, run the following commands:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cmake -B build/
</pre></div>
</div>
<p>This creates a separate <code class="docutils literal notranslate"><span class="pre">build</span></code> directory where all the build files
(including intermediate object files) will be created. This keeps your
directory structure cleaner by separating your source files from your
build files. CMake will actually generate a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> inside the <code class="docutils literal notranslate"><span class="pre">build</span></code>
directory, and running <code class="docutils literal notranslate"><span class="pre">make</span></code> in that directory will result in a <code class="docutils literal notranslate"><span class="pre">libstarwars.so</span></code> library being built
inside the <code class="docutils literal notranslate"><span class="pre">build</span></code> directory.</p>
<p>While it may seem odd that we went through several Make exercises, to
then reveal we’re not using Make in the course project, it’s hard to
understand how CMake works if you don’t first understand how the
underlying Make system works (and not just that, there are lots of projects
out there that use Make exclusively). We’re not covering CMake in detail
here because, as you can see above (and as you’ll see in the course
project), the CMake syntax is pretty intuitive and easy to pick up
on your own once you understand the basics of build systems.</p>
</div>
<div class="section" id="submitting-your-homework">
<h2>Submitting your homework<a class="headerlink" href="#submitting-your-homework" title="Permalink to this headline">¶</a></h2>
<p>Before submitting, make sure you’ve added, committed, and pushed all
your code to GitHub. Like the previous homework, you will submit your code
through Gradescope,</p>
<p>When submitting through Gradescope, you will be given the option of
manually uploading files, or of uploading a GitHub repository (we
recommend the latter, as this ensures you are uploading exactly the
files that are in your repository). If you upload your repository, make
sure you select your <code class="docutils literal notranslate"><span class="pre">2021-hw3-GITHUB_USERNAME</span></code> repository, with
“main” as the branch. Please note that you can submit as many times as
you want before the deadline.</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2011-2021, The University of Chicago.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.0.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>